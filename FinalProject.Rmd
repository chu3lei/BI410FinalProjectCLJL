---
title: "BI410 Final Project"
author: "Chu Lei & Jennifer Linnaea"
date: "2025-19-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-libraries-lab, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
#Loading the libraries needed for the project.
library(tidyr)
library(terra)
library(ggplot2)
library(dplyr)
library(sf)
library(ggspatial)
library(RColorBrewer)
library(viridisLite)
library(readxl)
```


```{r}
#We need two files for this project: 
#1) The OBA data (csv file) #Note: identical dim() to the oba .xlsx file
#2) The Oregon ecoregions data (polygon shape file)
#Reading in the files:
oba <- read.csv('../OBA_2018-2024.csv')
ecoregions_shp <- st_read("../ecoregion_shp_data/ecoregion.shp") #Jennifer
# Chu 
#ecoregions_shp <- st_read("../ecoregion.shp")
```


```{r}
#Visualizing the bee data. Use decimalLatitude and decimalLongitude as key
head(oba)
```


```{r}
#visualizing the ecoregions data
str(ecoregions_shp)
names(ecoregions_shp)

```

```{r}
#Visualizing the ecoregions data part 2: A map of Oregon ecoregions
eco_vect <- vect(ecoregions_shp)
r <- rast(ext(eco_vect), resolution =  1000) 
raster_output <- rasterize(ecoregions_shp, r, field = "ECO")

plot(raster_output)
```


For this project, we will be using only bee-plant interactions that occurred in coastal regions of Oregon, specifically region 1.a. Coastal Lowlands and 1.b. Coastal Uplands. However, the oba data does not have a column representing ecoregion that would allow us to subset the data. So we will join the oba data with the ecoregions data. To do this, it will be helpful to know the coordinate reference system used for the location data in the oba dataset. According to Dr. Ponisio, it is: DATUM: WGS84, unprojected lat long. EPSG code: 4326. 


```{r}
#The first step in joining the two datasets is to convert the oba data into a spatial object. We'll do so using st_as_sf()
#Note: 'sf' stands for 'simple features'

#However, the function will not accept data that has missing coordinate values, and ours does. So we will need remove any rows in the dataframe that don't have latitude and longitude values. 

sum(is.na(oba$decimalLongitude)) #there are 36
sum(is.na(oba$decimalLatitude)) #there are 36

oba_sf <- oba %>% drop_na(c(decimalLongitude, decimalLatitude))

oba_sf <- st_as_sf(oba_sf, coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)

```


```{r}
#Next, we need to check if ecoregions_shp is in WGS84 (EPSG:4326) and if not, reproject it
st_crs(ecoregions_shp) == st_crs(oba_sf) #FALSE before the reprojection
oba_sf <- st_transform(oba_sf, st_crs(ecoregions_shp))
st_crs(ecoregions_shp) == st_crs(oba_sf) #TRUE after the reprojection
```


```{r}
#Now that the two sf objects have the same projection, we can join them.
#Note: The argument 'join=st_intersects' says that each point in the oba
#dataset will be assigned to the polygon(ecoregion) it lies within
oba_with_ecoregions_sf <- st_join(oba_sf, ecoregions_shp, join = st_intersects)
head(oba_with_ecoregions_sf)
```



```{r}
#Now there is an ecoregion assigned to each observation.
#However,for now, a regular dataframe will be easier to work with.
#Converting oba data back to a dataframe:
oba_with_ecoregions <- oba_with_ecoregions_sf |> st_drop_geometry()
head(oba_with_ecoregions)
```

```{r}
#test cell. 
#observing the ecoregion column
oba_with_ecoregions$ECO
#Chu it worked it worked!
```

Now that we have successfully joined the data, we can subset it to only the coastal regions 1a and 1b.

```{r}
#subsetting to coastal data only (ecoregions 1a (coastal lowlands) and 1b (coastal uplands))

coastal_oba <- subset(oba_with_ecoregions, ECO == '1a' | ECO == '1b')
coastal_oba
```




Next, we need to add a column that's TRUE if the plant species is native 
to Oregon, and FALSE if not. I'm going to populate this by hand with data from 
oregonflora.org.

```{r}
#First, what are the unique plant species in our data?
plant_sp_list <- sort(unique(coastal_oba$speciesPlant))
#length(plant_sp_list) #there are 204
plant_sp_list
```


```{r}
#cell for cleaning and mutating plant names

#The 'x' designation for hypbrids came through in this dataset as 'Ã—'. I'm going to change it to 'x'.
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Arctostaphylos Ã— media'] <- 'Arctostaphylos x media'
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Erica Ã— darleyensis'] <- 'Erica x darleyensis'
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Erysimum Ã— cheiri'] <- 'Erysimum x cheiri'
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Leucanthemum Ã— superbum'] <- 'Leucanthemum x superbum'
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Spiraea Ã— vanhouttei'] <- 'Spiraea x vanhouttei'


#Note: Brassica campestris and Brassica rapa are synonyms. 
#Mutating all instances of Brassica campestris to Brassica rapa
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Brassica campestris'] <- 'Brassica rapa'

#I'm mutating Cuscata pacifica var. pacifica to simply Cuscata pacifica, since there are 
#no other Cuscata pacifica varieties in the data 
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Cuscuta pacifica pacifica'] <- 'Cuscuta pacifica'

#I'm also mutating Cuscuta salina to Cuscuta pacifica. Oregon flora redirects the former to the latter.
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Cuscuta salina'] <- 'Cuscuta pacifica'

#Altering the data to include the subspecies Epilobium ciliatum ciliatum in Epilobium ciliatum.
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Epilobium ciliatum ciliatum'] <- 'Epilobium ciliatum'

#Altering the data to include the subspecies Grindelia stricta stricta in Grindelia stricta.
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Grindelia stricta stricta'] <- 'Grindelia stricta'

#Altering the data to include the subspecies Lotus pedunculatus pedunculatus in Lotus pedunculatus.
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Lotus pedunculatus pedunculatus'] <- 'Lotus pedunculatus'

#Note: Rubus bifrons and Rubus armeniacus are synonyms. 
#Mutating all instances of Rubus bifrons to Rubus armeniacus
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Rubus bifrons'] <- 'Rubus armeniacus'

#Note: Solidago canadensis and Solidago elongata are synonyms. 
#Mutating all instances of Solidago canadensis to Solidago elongata
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Solidago canadensis'] <- 'Solidago elongata'

#Altering the data to include the subspecies Solidago spathulata spathulata in Solidago spathulata.
coastal_oba$speciesPlant[coastal_oba$speciesPlant == 'Solidago spathulata spathulata'] <- 'Solidago spathulata'


plant_sp_list <- sort(unique(coastal_oba$speciesPlant))
plant_sp_list
```


```{r}
#We used the plant_list to create an excel file, and hand-populated an IsNative 
#column with Boolean values. Native = TRUE, Non-native = FALSE

#reading in the excel table of native/non-native plant species information
isnative_table <- read_excel("../BI410FinalProjectCLJL/plant_species_list.xlsx", sheet = "Sheet1") 

#What is the length of the plant_sp_list (which still includes NA data as "")?
length(plant_sp_list) #195
#What is the length of the isnative_table? (which also includes an NA row)
length(isnative_table$Species) #195

#Since the two are now the same length, each plant species represented in the 
#coastal_oba data is now also represented in the isnative_table.
#Therefore we can do a left join with confidence
#(Note that we still haven't dealth with NA values)

```



```{r}
#names(isnative_table) #Species, IsNative, Common Name
#names(coastal_oba) #Plant species column is called "speciesPlant"

#Since the columns we want to merge these files on have different names,
#we'll change the name of isnative_table to match our OBA plant sp. column name:
names(isnative_table)[names(isnative_table) == "Species"] <- "speciesPlant"

#Note: was formerly called merged_df. Changing to add the column to coasal_oba
#Now we can do the merge
coastal_oba <- coastal_oba %>%
  left_join(isnative_table, by = "speciesPlant") 

head(coastal_oba)
```

```{r}
#Looking at the column names of the coastal_oba DataFrame. The new columns are there.
names(coastal_oba)

```

Now we have all the information we need to run our analysis in one DataFrame.
For the A/B test, we'll cut the columns we don't need. 

```{r}
#Creating a DataFrame for the A/B test containing only the columns we need
#and keeping only bee genus and species, plant genus and species, and IsNative
clean_df <- coastal_oba %>%
  select(speciesPlant, IsNative, genus, specificEpithet)

summary(clean_df)
#We have 937 NA's in the IsNative column.
#These should be present in any row where speciesPlant has a value of "".
#Will check this:
sum(clean_df$speciesPlant == "") #937
#As expected, there are 937 rows without a species name. 

#To do the A/B analysis, we will have to drop the rows without species names.
#However, this may introduce bias into our analysis if these rows are not 
#random but are a certain subset of the collections.
```


```{r}
#Combining bee genus and bee species into one column and dropping old cols:
clean_df$bee_species <- paste(clean_df$genus, clean_df$specificEpithet)
clean_df <- clean_df %>%
  select(speciesPlant, IsNative, bee_species)
head(clean_df)
```


```{r}
#Calculating the statistic:
#To Chu. 11/28/25: Our statistic may be flawed because we didn't account for the number
#of _observations_ on native vs. nonnative flowers? As Dr. Ponisio said, we may need to standardize. But for now I'll leave it


obs <- clean_df %>%
  group_by(IsNative) %>%
  summarise(n_bee_species = n_distinct(bee_species))

print(obs) #This is interesting. There were 74 bee spp. seen on nonnative plant
#species and 73 bee sp. seen on native plant species. The number of bee species 
#seen on NA plants was 76, which is too bad as we're going to lose data from a 
#couple of bee spp. entirely when we drop NA rows.

obs_stat <- obs$n_bee_species[obs$IsNative == TRUE][1] -
            obs$n_bee_species[obs$IsNative == FALSE][1]

obs_stat #is -1 NA unless I subset in the line above
```
```{r}
#test cell. Remove when done.
obs$n_bee_species[obs$IsNative == TRUE][1]

```



```{r}

test <- clean_df %>%
  mutate(IsNative_shuffled = sample(IsNative)) %>%
  group_by(IsNative_shuffled) %>%
  summarise(n_bee_species = n_distinct(bee_species))





set.seed(1)

n_sim <- 1000
sim_stats <- numeric(n_sim)

for (i in 1:n_sim) {

  shuffled <- clean_df %>% 
    mutate(IsNative_shuffled = sample(IsNative))

  stat_tbl <- shuffled %>%
    group_by(IsNative_shuffled) %>%
    summarise(n_bee_species = n_distinct(bee_species))

  sim_stats[i] <- stat_tbl$n_bee_species[stat_tbl$IsNative_shuffled == TRUE] -
                  stat_tbl$n_bee_species[stat_tbl$IsNative_shuffled == FALSE]
}

hist(sim_stats,
     main = "Permutation test: distribution of (bee species visiting native - non-native)",
     xlab = "Difference in number of bee species (Native - Non-native)")
abline(v = obs_stat, col = "red", lwd = 2)
legend("topright", legend = paste("Observed =", obs_stat), col = "red")
```

#Note: 
If this is the case, we'd reject the null. Let's standardize and see if we get something different.





